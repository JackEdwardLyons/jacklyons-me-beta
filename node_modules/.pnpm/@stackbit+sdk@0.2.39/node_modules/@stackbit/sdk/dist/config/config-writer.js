"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.convertToYamlConfig = exports.writeConfig = void 0;
const path_1 = __importDefault(require("path"));
const fs_extra_1 = __importDefault(require("fs-extra"));
const js_yaml_1 = __importDefault(require("js-yaml"));
const lodash_1 = __importDefault(require("lodash"));
const packageJson = require('../../package.json');
async function writeConfig({ dirPath, config }) {
    const yamlConfig = convertToYamlConfig({ config });
    const filePath = path_1.default.join(dirPath, 'stackbit.yaml');
    const yamlString = js_yaml_1.default.dump(yamlConfig);
    const info = `# This file was generated by @stackbit/sdk v${packageJson.version}\n` +
        '# To learn more about stackbit.yaml please visit https://www.stackbit.com/docs/stackbit-yaml/\n';
    const data = info + yamlString;
    await fs_extra_1.default.outputFile(filePath, data);
}
exports.writeConfig = writeConfig;
function convertToYamlConfig({ config }) {
    const yamlConfig = lodash_1.default.cloneDeep(lodash_1.default.omit(config, 'models'));
    if (!lodash_1.default.isEmpty(config.models)) {
        yamlConfig.models = lodash_1.default.reduce(config.models, (yamlModels, model) => {
            if (model.type === 'image') {
                return yamlModels;
            }
            const yamlModel = lodash_1.default.omit(model, ['name', '__metadata']);
            if (yamlModel.type === 'page' && !yamlModel.hideContent && yamlModel.fields) {
                lodash_1.default.remove(yamlModel.fields, (field) => field.name === 'markdown_content');
            }
            if (yamlModel.type === 'page' && yamlModel.fields) {
                lodash_1.default.remove(yamlModel.fields, (field) => field.name === (config.pageLayoutKey || 'layout'));
            }
            if (yamlModel.type === 'data' && yamlModel.fields) {
                lodash_1.default.remove(yamlModel.fields, (field) => field.name === (config.objectTypeKey || 'type'));
            }
            yamlModels[model.name] = yamlModel;
            return yamlModels;
        }, {});
    }
    return yamlConfig;
}
exports.convertToYamlConfig = convertToYamlConfig;
//# sourceMappingURL=config-writer.js.map